// ==UserScript==
// @name             Tieba Image Save
// @name:zh-CN       贴吧图楼打包
// @namespace        sgly
// @version          1.0
// @description      Grab and zip all image in a tieba post
// @author           SgLy
// @match            https://tieba.baidu.com/p/*
// @grant            GM_xmlhttpRequest
// @grant            GM_registerMenuCommand
// @require          https://cdn.jsdelivr.net/npm/file-saver/FileSaver.min.js
// @require          https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js
// @compatible       chrome
// ==/UserScript==
!function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){const n=[],a=e=>{n.push(e)},o=e=>{const t=`[${(new Date).toISOString()}] `+e;n.forEach(e=>{e(t)})};const i=[];a(e=>{i.push(e)});e.exports={limit:function(e,t){let n=0,a=0;const i=[];return async function(...r){const s=async function(...e){n++;const r=a++;o(`[#${r}] Requesting ${e[0]}\n`);const s=await t(...e),c=1e3*Math.random();return o(`[#${r}] Done, waiting ${c}\n`),setTimeout(async()=>{if(n--,i.length>0){const e=i.shift();(async()=>{const t=await e.func(...e.args);e.resolve(t)})()}},c),s};return n>=e?new Promise(e=>{i.push({func:s,args:r,resolve:e})}):await s(...r)}},log:o,appendLogStep:a,zipFiles:async(e,t)=>{const n=new JSZip;return Object.keys(e).forEach(t=>{n.file(t,e[t])}),await n.generateAsync({type:"blob"},t)}}},function(e,t,n){const{limit:a,log:o,appendLogStep:i,zipFiles:r}=n(0),{registerMenuCommand:s,request:c}=n(2),{$:l,createProgress:d,ALL_STATE:p}=n(3),f=a(10,c);let h;async function u({tid:e,lastId:t,index:n}){try{o(`获取第${n}页，上一页末图ID：${t}`);return(await f("https://tieba.baidu.com/photo/bw/picture/guide",{responseType:"json",params:{kw:"",tid:e,see_lz:1,from_page:0,alt:"jview",next:15,prev:15,pic_id:t,_:Date.now()}})).data}catch(e){throw o(`获取第${n}页出错`),e}}async function g({tid:e,firstId:t}){try{o("获取图片列表"),h.addStep("fetchPhotoList","获取图片列表"),h.changeStepState("fetchPhotoList",p.GOING);const n=await async function({tid:e,firstId:t}){const n={};let a=1,o=t,i=0,r=-1;for(;;){const t=await u({tid:e,lastId:o,index:a});if(i=Math.max(i,t.pic_amount),Object.keys(t.pic_list).forEach(e=>{n[e]=t.pic_list[e];const a=parseInt(e.replace(/^#/,""));a>r&&(r=a,o=n[e].img.original.id)}),Object.keys(n).length>=i)break;a+=1}return n}({tid:e,firstId:t});return n?(h.changeStepState("fetchPhotoList",p.SUCCESS),o("图片列表："+JSON.stringify(n)),n):(o("图片列表为空"),void h.changeStepState("fetchPhotoList",p.FAILED))}catch(e){throw h.changeStepState("fetchPhotoList",p.FAILED),e}}async function m({list:e}){try{h.addStep("fetchAllImage","获取所有图片"),h.changeStepState("fetchAllImage",p.GOING);const t=await Promise.all(Object.keys(e).map(t=>async function({list:e,id:t}){let n;h.addImage(t);try{o("获取图片 "+t),n=e[t].img.original.waterurl,h.changeImageState(t,p.GOING);const a=await f(n,{responseType:"arraybuffer",onProgress:e=>{e.lengthComputable&&h.updateImageProgress(t,e.loaded/e.total*100)}}),i=n.match(/(\.[a-zA-Z0-9]+)$/)[1];return h.changeImageState(t,p.SUCCESS),{name:`${t.slice(1)}${i}`,content:a}}catch(e){throw o(`获取图片失败：ID=${t}, URL=${n}`),h.changeImageState(t,p.FAILED),e}}({list:e,id:t})));h.changeStepState("fetchAllImage",p.SUCCESS);const n={};return t.forEach(e=>{n[e.name]=e.content}),n}catch(e){throw h.changeStepState("fetchAllImage",p.FAILED),e}}async function S({title:e,tid:t}){try{o(`开始获取，标题：${e}，帖子ID：${t}`);const n={},a=await(async({tid:e})=>{h.addStep("fetchPhotoPage","获取首图ID"),h.changeStepState("fetchPhotoPage",p.GOING),o("获取图楼页，帖子ID："+e);try{const t=await f("https://tieba.baidu.com/photo/p",{params:{tid:e}});h.changeStepState("fetchPhotoPage",p.SUCCESS);const n=t.match(/url_pic_id = "([0-9a-f]{40})"/);if(null===n)return o("错误：没有图楼"),void h.changeStepState("fetchPhotoPage",p.FAILED);const a=n[1];return o("首图ID："+a),a}catch(e){throw h.changeStepState("fetchPhotoPage",p.FAILED),e}})({tid:t}),i=await g({tid:t,firstId:a});n["meta.json"]=JSON.stringify(i,null,2);const s=await m({list:i});Object.keys(s).forEach(e=>{n[e]=s[e]});const c=await async function({allFiles:e}){try{return o("全部获取完成，压缩中"),h.addStep("zip","压缩",!0),h.changeStepState("zip",p.GOING),h.changeStepState("zip",p.SUCCESS),await r(e,e=>{h.updateStepProgress("zip",e.percent,e.currentFile)})}catch(e){throw h.changeStepState("zip",p.FAILED),e}}({allFiles:n});await async function({name:e,file:t}){try{o("压缩完毕，下载"),h.addStep("download","下载"),h.changeStepState("download",p.GOING),saveAs(t,e),h.changeStepState("download",p.SUCCESS)}catch(e){throw h.changeStepState("download",p.FAILED),e}}({name:e+".zip",file:c})}catch(e){o("错误："+e),o("获取失败，流程结束")}}const y=()=>{try{return l("#j_core_title_wrap h3")[0].title}catch(e){return o("can not get title"),document.title}};s("Download",async()=>{h=d(),i(e=>{h.addLog(e)}),await S({title:y(),tid:new URL(document.URL).pathname.match(/(\d+)/)[0]})})},function(e,t,n){const{log:a}=n(0),o=GM_registerMenuCommand;e.exports={registerMenuCommand:o,request:(e,{responseType:t="text",params:n={},onProgress:o=(()=>{})})=>{const i=new URL(e),r=new URLSearchParams;let s,c;Object.keys(n).forEach(e=>{r.set(e,n[e])}),i.search=r.toString();const l=new Promise((e,t)=>{s=e,c=t});let d=0;const p=({success:e,fail:n})=>{GM_xmlhttpRequest({url:i.href,method:"GET",responseType:t,onload:t=>{200!==t.status?n("status code: "+t.status):e(t.response)},onerror:e=>{n("Request error: "+e)},onprogress:o})},f=e=>{a(`Request ${i.href} ok`),s(e)},h=e=>{d<3?(d++,a(`Request ${i.href} fail, reason: ${e}, retrying (${d+1} attempt)`),p({success:f,fail:h})):(a(`Request ${i.href} fail, reason: ${e}, retrying up to 3 times, failing`),c(e))};return p({success:f,fail:h}),l}}},function(e,t){const n=(e="div",t,n={},a="",o=[])=>{o.push("tieba-image-saver");const i=document.createElement(e);return t&&(i.id=r+t),o.forEach(e=>i.classList.add(e)),Object.keys(n).forEach(e=>{i.style[e]=n[e]}),i.innerText=a,i},a=document.createElement("style");a.innerHTML="\n";let o=null;const i=document.getElementsByTagName("body")[0],r="tieba-image-saver-",s={WAITING:0,GOING:1,SUCCESS:2,FAILED:3},c={[s.WAITING]:"grey",[s.GOING]:"blue",[s.SUCCESS]:"green",[s.FAILED]:"red"},l={[s.WAITING]:"…",[s.GOING]:"•",[s.SUCCESS]:"✔",[s.FAILED]:"✘"};e.exports={$:(e,t=document)=>Array.from(t.querySelectorAll(e)),createProgress:()=>{o&&o.parentElement&&o.parentElement.removeChild(o),i.appendChild(a),o=n("div","container",{position:"fixed",left:0,top:0,height:"100vh",width:"100vw",opacity:0,transition:"opacity 0.1s ease-in-out",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center"}),setTimeout(()=>{o.style.opacity=1}),i.appendChild(o);const e=n("div","mask",{position:"absolute",left:0,top:0,height:"100vh",width:"100vw",backgroundColor:"rgba(0, 0, 0, 0.6)",zIndex:-1});o.appendChild(e);const t=n("div","inner-container",{borderRadius:"5px",fontSize:"1.2em",backgroundColor:"white",padding:"1.5em",display:"flex",flexDirection:"column",maxWidth:"min(720px, 80vw)"});o.appendChild(t);const r=n("h2","title",{fontFamily:"sans",marginBottom:"1em"},"打包下载");t.appendChild(r);const d=n("div","step-list",{fontFamily:"sans",display:"flex",flexDirection:"column",justifyContent:"flex-start"});t.appendChild(d);const p=n("div","image-list",{fontFamily:"monospace",display:"flex",flexDirection:"row",justifyContent:"flex-start",margin:"1em 0",flexWrap:"wrap",width:"50em"});t.appendChild(p);const f=n("div","show-log",{fontFamily:"sans",display:"flex",flexDirection:"column",justifyContent:"flex-start",color:"navy"},"展开详细日志");t.appendChild(f);const h=n("div","detail-logs",{fontFamily:"monospace",fontSize:"0.8em",whiteSpace:"pre",display:"flex",flexDirection:"column",justifyContent:"flex-start",height:"2em",overflow:"hidden",transition:"height 0.1s ease-in-out",maxWidth:"100%"});t.appendChild(h);let u=!1;{let e;const t=()=>{h.style.overflow="hidden",h.style.height="2em",f.innerText="展开详细日志",h.scroll(0,Number.MAX_SAFE_INTEGER),u=!0,e=n},n=()=>{h.style.overflow="auto",h.style.height="20em",f.innerText="收起详细日志",e=t};e=n,f.onclick=()=>{e()}}const g=[],m={},S={};return{remove(){o.style.opacity=0,setTimeout(()=>{o.parentElement.removeChild(o),a.parentElement.removeChild(a)},100)},addStep(e,t,a=!1){if(m[e]){const t=m[e].step;t.parentElement.removeChild(t)}const o=n("div",null,{display:"flex",flexDirection:"row",background:"transparent",alignItems:"center"}),i=n("div",null);o.appendChild(i);const r=n("div",null,{marginLeft:"8px"},t);if(o.appendChild(r),d.appendChild(o),m[e]={state:i,step:o,text:r},a){const t=n("div",null,{width:"5em",padding:"0 8px",marginLeft:"1em",borderRadius:"5px",background:"#f2f2f2",height:"0.8em",textAlign:"center"});o.appendChild(t);const a=n("div",null,{marginLeft:"1em",color:"grey"});o.appendChild(a),m[e].progress=t,m[e].stateText=a}return this.changeStepState(e,s.WAITING),m[e]},changeStepState(e,t){const{state:n}=m[e];n.style.color=c[t],n.innerText=l[t]},updateStepProgress(e,t,n){const{progress:a,stateText:o}=m[e];a&&(a.style.background=`linear-gradient(90deg, #e6e6e6 0%, #e6e6e6 ${t}%, #f2f2f2 ${t}%, #f2f2f2 100%)`,o.innerText=n)},addImage(e){if(S[e]){const t=S[e].image;t.parentElement.removeChild(t)}const t=n("div",null,{width:"3em",display:"flex",flexDirection:"row",padding:"0 8px",justifyContent:"space-between",marginRight:"1em",marginBottom:"0.5em",borderRadius:"5px",background:"#f2f2f2"});t.appendChild(n("div",null,{},e));const a=n("div",null);return t.appendChild(a),p.appendChild(t),S[e]={image:t,state:a},this.changeImageState(e,s.WAITING),S[e]},changeImageState(e,t){const{state:n}=S[e];n.style.color=c[t],n.innerText=l[t]},updateImageProgress(e,t){const{image:n}=S[e];n.style.background=`linear-gradient(90deg, #e6e6e6 0%, #e6e6e6 ${t}%, #f2f2f2 ${t}%, #f2f2f2 100%);`},addLog(e){let t=(n=h).offsetHeight+n.scrollTop===n.scrollHeight;var n;g.push(e),h.innerText=g.join("\n"),(t||u)&&(u=!1,h.scroll(0,Number.MAX_SAFE_INTEGER))}}},ALL_STATE:s}}]);